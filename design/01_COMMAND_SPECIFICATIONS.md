# SOYAL 701Server 命令規格文檔

## 📅 文檔資訊
- **版本**：2.0
- **日期**：2024-11-20
- **基於規格**：701Server JSON Command v1.05 + Command 2000 v1.01
- **狀態**：✅ 完整規格定義

---

## 🎯 支援的命令總覽

| 命令 | 名稱 | 用途 | 實現狀態 |
|------|------|------|----------|
| **1021** | 設定訪客標籤 UID 和時間限制 | 高層 API，簡單易用 | ✅ 已完成 |
| **1022** | 清除訪客標籤 | 刪除訪客權限 | ✅ 已完成 |
| **2000** | HEX 格式協議傳輸 | 底層協議，功能完整 | 🔄 待重構 |

---

## 📋 Command 1021：設定訪客標籤

### 官方規格

#### JSON 格式
```json
{
  "l_user": "login user",
  "cmd_array": [{
    "c_cmd": 1021,
    "Area": 0,
    "Node": 1,
    "Addr": 200,
    "TagUID": "0x1234567890ABCDEF",
    "Begin_dt": "2024-11-19 09:00",
    "End_dt": "2024-11-19 17:00"
  }]
}
```

#### 參數規格

| 參數 | 類型 | 必填 | 說明 | 範圍/格式 |
|------|------|------|------|-----------|
| `c_cmd` | INT | ✅ | 命令代碼 | 固定為 1021 |
| `Area` | INT | ⚪ | 區域編號 | 0-15，預設 0 |
| `Node` | INT | ✅ | 節點編號 | 1-255 |
| `Addr` | INT | ✅ | 位址 | 0-32767 |
| `TagUID` | String | ✅ | 8 bytes UID (HEX) | "0x..." 16 字符 |
| `Begin_dt` | String | ✅ | 開始時間 | "YYYY-MM-DD HH:MM" |
| `End_dt` | String | ✅ | 結束時間 | "YYYY-MM-DD HH:MM" |

#### 選用參數（高級功能）

| 參數 | 類型 | 說明 |
|------|------|------|
| `Lift` | String | 4 bytes 電梯控制 (HEX) |
| `DoorAccess` | String | 2 bytes 門禁權限 (HEX) |
| `PIN` | INT | 個人識別碼 (0-999999999) |
| `Mode` | INT | 驗證模式 (0/1/2/3) |
| `Alias` | String | LCD 顯示名稱 |

#### 回應格式
```json
{
  "resp_array": [{
    "c_resp": 4,
    "Area": 0,
    "Node": 1
  }]
}
```

- `c_resp = 4`：ACK（成功）
- `c_resp = 5`：NACK（失敗）

---

## 📋 Command 1022：清除訪客標籤

### 官方規格

#### JSON 格式
```json
{
  "l_user": "login user",
  "cmd_array": [{
    "c_cmd": 1022,
    "Area": 0,
    "Node": 1,
    "Addr": 200
  }]
}
```

#### 參數規格

| 參數 | 類型 | 必填 | 說明 | 範圍/格式 |
|------|------|------|------|-----------|
| `c_cmd` | INT | ✅ | 命令代碼 | 固定為 1022 |
| `Area` | INT | ⚪ | 區域編號 | 0-15，預設 0 |
| `Node` | INT | ✅ | 節點編號 | 1-255 |
| `Addr` | INT | ✅ | 位址 | 0-32767 |

**注意**：1022 命令不需要 TagUID，只通過 Addr 識別要刪除的訪客。

#### 回應格式
```json
{
  "resp_array": [{
    "c_resp": 4,
    "Area": 0,
    "Node": 1
  }]
}
```

---

## 📋 Command 2000：HEX 格式協議傳輸

### 官方規格

#### JSON 格式
```json
{
  "l_user": "login user",
  "cmd_array": [{
    "c_cmd": 2000,
    "Area": 0,
    "Node": 1,
    "Hex": "0x8B570000C80000000010C73792..."
  }]
}
```

#### 參數規格

| 參數 | 類型 | 必填 | 說明 |
|------|------|------|------|
| `c_cmd` | INT | ✅ | 命令代碼，固定為 2000 |
| `Area` | INT | ✅ | 區域編號 |
| `Node` | INT | ✅ | 節點編號 |
| `Hex` | String | ✅ | HEX 協議字串（必須以 "0x" 開頭） |

### 用途說明

Command 2000 是**通用底層協議傳輸指令**，用於：
- 直接發送 SOYAL 原始協議指令
- 支援所有控制器功能
- 需要了解底層協議格式

### 支援的協議功能

#### 1. 控制門鎖（21H 協議）
```json
{
  "c_cmd": 2000,
  "Area": 0,
  "Node": 1,
  "Hex": "0x2184"
}
```

#### 2. 設定訪客（8BH 協議）
```json
{
  "c_cmd": 2000,
  "Area": 0,
  "Node": 1,
  "Hex": "0x8B570000C80000000010C73792000004BC86FFFFFF1606100A1B1706100A1B000000FF"
}
```

**HEX 字串結構**（8BH 協議）：
```
8B                      協議指令碼
57                      子指令
0000                    保留
C8                      用戶位址（200）
00000000                保留
10C7                    卡號第一部分
3792                    卡號第二部分
000004BC                密碼（1212）
86                      通行模式
FFFFFF                  門禁權限
1606100A1B              開始時間
1706100A1B              結束時間
000000                  保留
FF                      通行樓層/其他設定
```

#### 3. 設定控制器時間（23H 協議）
```json
{
  "c_cmd": 2000,
  "Area": 0,
  "Node": 1,
  "Hex": "0x23071B0A05100616"
}
```

時間格式：秒.分.時.週.日.月.年（HEX）

---

## 🔄 命令對比分析

### Command 1021 vs Command 2000 (8BH)

| 特性 | Command 1021 | Command 2000 (8BH) |
|------|--------------|-------------------|
| **層級** | 高層 JSON API | 底層協議指令 |
| **易用性** | ✅ 極易使用 | ⚠️ 需要協議知識 |
| **參數格式** | JSON 結構化 | HEX 字串 |
| **卡號格式** | HEX String | HEX Bytes |
| **時間格式** | "YYYY-MM-DD HH:MM" | YY MM DD HH MM (Hex) |
| **密碼** | ❌ 不支援 | ✅ 支援 |
| **門禁權限** | ❌ 不支援 | ✅ 支援 |
| **通行模式** | ❌ 不支援 | ✅ 支援 |
| **電梯樓層** | ❌ 不支援* | ✅ 支援 |
| **調試難度** | 簡單 | 困難 |

*註：官方 1021 不支援，但可透過 `Lift` 選用參數實現

### 使用建議

#### 使用 Command 1021 的場景 ✅
- 簡單的訪客管理
- 只需要卡號和時間限制
- 追求易用性和可維護性
- 不需要密碼或門禁權限

#### 使用 Command 2000 的場景 ✅
- 需要設定密碼
- 需要設定門禁權限
- 需要設定通行樓層
- 需要控制門鎖、讀取 I/O 等其他功能
- 需要完全控制協議內容

---

## 🎯 TagUID 格式規範

### 使用者輸入格式
```
"數字:數字"
範例：04295:14226
```

### 內部儲存格式（Command 1021）
```
8 bytes HEX String
範例："0x0000000010C73792"
```

### 轉換演算法
```
公式：HEX_TagUID = (第一個數字 << 16) | 第二個數字

範例：
  輸入：04295:14226
  第一個數字：04295 = 0x10C7
  第二個數字：14226 = 0x3792
  計算：(0x10C7 << 16) | 0x3792 = 0x10C73792
  格式化：0x0000000010C73792
```

### Command 2000 中的卡號
在 8BH 協議中，卡號直接使用兩個 16 位 HEX 值：
```
10C7 3792
```

---

## 📊 時間格式規範

### Command 1021 時間格式
```
格式：YYYY-MM-DD HH:MM（字串）
範例："2024-11-19 09:00"
長度：16 字符
```

### Command 2000 時間格式（8BH 協議）
```
格式：YY MM DD HH MM（HEX bytes）
範例：16 06 10 0A 1B
說明：2022年 6月 16日 10時 27分
```

---

## 🔧 Addr（位址）參數

### 用途
- 在控制器記憶體中標識訪客記錄的位置
- 範圍：0-32767

### Command 1021
- 必要參數
- 用於指定儲存位置

### Command 1022
- 必要參數
- 通過位址刪除訪客（不需要 TagUID）

### 當前實現策略
- 固定使用 `Addr = 0`
- 簡化操作，適合單一訪客場景
- 未來可擴展為動態管理

---

## ⚠️ 重要限制

### 硬體支援
Command 1021/1022 僅支援：
- 企業版 Enterprise E 控制器
- 多門控制器 AR-716-E16

範例設備：AR-837E-A（企業版網絡型液晶顯示控制器）

### 軟體要求
- SOYAL 701Server/701Client 版本 10V2
- 支援 File base 或 SQL Database 模式

---

## 📚 相關文檔

- `spec/701Server JSON Command 文件.md` - 1021/1022 官方規格
- `spec/701ServerJsonCommand2000.md` - 2000 官方規格
- `TAGUID_CONVERSION_ANALYSIS.md` - TagUID 轉換詳解
- `COMMAND_2000_ANALYSIS.md` - Command 2000 深度分析

---

**文檔版本**：2.0  
**最後更新**：2024-11-20  
**狀態**：✅ 完整定義
